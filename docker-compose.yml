version: '2.3'
services:

  postgres:
    image: postgres:9.6.1-alpine
    env_file:
      - ./common.env
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:6.0-rc3-alpine

  elasticsearch:
    image: blacktop/elasticsearch:6.8
    environment:
      discovery.type: single-node
      ES_JAVA_OPTS: "-Xms750m -Xmx750m"
    volumes:
      - elasticsearch:/usr/share/elasticsearch/data

  base:
    restart: on-failure
    scale: 1
    mem_limit: 1024m
    build:
      context: .
      target: base
      dockerfile: Dockerfile
    volumes:
      - ./:/monorepo

  api:
    restart: on-failure
    scale: 1
    mem_limit: 1024m
    command: ["pm2-runtime", "ecosystem.config.js", "--only", "api"]
    build:
      context: .
      target: service
      dockerfile: Dockerfile
    ports:
      - 9000:9000
    volumes_from:
      - base

  frontend:
    restart: on-failure
    scale: 1
    mem_limit: 1024m
    command: ["pm2-runtime", "ecosystem.config.js", "--only", "frontend"]
    build:
      context: .
      target: service
      dockerfile: Dockerfile
    ports:
      - 3000:3000
    volumes_from:
      - base
    volumes:
      - ./packages/shared:/monorepo/packages/frontend/src/shared:ro


volumes:
  pgdata:
    driver: local
  elasticsearch:
    driver: local

